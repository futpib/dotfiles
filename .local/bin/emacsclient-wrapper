#!/usr/bin/env -S deno run --allow-env --allow-read --allow-run=emacsclient

import { execa } from 'npm:execa@^6.1.0';
import { globby } from 'npm:globby@^13.2.2';

async function main(query) {
    if (!query) {
        console.log('No filename provided');
        Deno.exit(1);
    }

    try {
        const url = new URL(query);
        query = url.pathname;
    } catch (error) {
        // ignore
    }

    while (query) {
        console.log('Searching for', query);

        try {
            await Deno.stat(query);

            await execa('emacsclient', ['-n', query], {
                stdio: 'inherit',
            });

            return;
        } catch (error) {
            // ignore
        }

        const files = await globby([ '**', query ].join('/'));

        if (files.length === 0) {
            console.log('No such file');
            query = query.split('/').slice(1).join('/');
            continue;
        }

        if (files.length > 1) {
            console.log('Multiple files found:');
            console.log(files.join('\n'));
            Deno.exit(1);
        }

        const file = files[0];

        await execa('emacsclient', ['-n', file], {
            stdio: 'inherit',
        });

        return;
    }

    Deno.exit(1);
}

main(Deno.args[0]);

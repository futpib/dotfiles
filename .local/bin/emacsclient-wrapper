#!/usr/bin/env bash

filepath_argument="$1"
line_column_argument=""

if [[ "$filepath_argument" =~ ^[^:]+:[0-9]+:[0-9]+$ ]]; then
    line_column_argument="$(echo "$filepath_argument" | cut -d : -f 2-3)"
    filepath_argument="$(echo "$filepath_argument" | cut -d : -f 1)"
elif [[ "$filepath_argument" =~ ^[^:]+:[0-9]+:in$ ]]; then
    line_column_argument="$(echo "$filepath_argument" | cut -d : -f 2)"
    filepath_argument="$(echo "$filepath_argument" | cut -d : -f 1)"
fi

if ! [ -f "$filepath_argument" ]; then
    filepath_without_prefix="${filepath_argument/[ab]\//}"
    if [ -f "$filepath_without_prefix" ]; then
        filepath_argument="$filepath_without_prefix"
    else
        readarray -t found_filepaths < <(find . -path '*'"$filepath_argument")
        if [ "${#found_filepaths[@]}" -eq 0 ]; then
            echo No such file
            exit 1;
        elif [ "${#found_filepaths[@]}" -eq 1 ]; then
            filepath_argument="$found_filepaths"
        else
            echo Multiple files found:
            echo "${found_filepaths[*]}" | xargs -n 1 echo
            exit 1;
        fi
    fi
fi

if [[ -z "$line_column_arguments" ]]; then
    emacsclient -n "$filepath_argument"
else
    emacsclient -c "$line_column_argument" -n "$filepath_argument"
fi
